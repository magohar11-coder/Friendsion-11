<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Friendsion 11 - Smart Diary</title>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>

body{
margin:0;
font-family:Georgia;
background:linear-gradient(135deg,#ff9a9e,#fad0c4,#fbc2eb,#a6c1ee);
display:flex;
flex-direction:column;
align-items:center;
min-height:100vh;
}

/* Controls */
.controls{
background:white;
padding:20px;
border-radius:15px;
margin:20px;
width:95%;
max-width:450px;
box-shadow:0 5px 15px rgba(0,0,0,0.2);
}

input,textarea{
width:100%;
margin:8px 0;
padding:8px;
border-radius:8px;
border:1px solid #ccc;
}

button{
background:#ff4081;
color:white;
border:none;
padding:10px;
border-radius:8px;
cursor:pointer;
font-weight:bold;
margin-top:5px;
}

/* Book */
.book{
width:350px;
height:500px;
position:relative;
margin-top:20px;
}

.page{
position:absolute;
width:100%;
height:100%;
background:#fffaf0;
border-radius:0 15px 15px 0;
transform-origin:left;
transition:0.6s;
box-shadow:5px 5px 15px rgba(0,0,0,0.3);
overflow:auto;
padding:20px;
}

.cover{
background:linear-gradient(135deg,#ff512f,#dd2476,#1fa2ff);
color:white;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
text-align:center;
}

.cover img{
width:80%;
height:150px;
object-fit:cover;
border-radius:10px;
margin:10px 0;
}

.profile{
display:flex;
align-items:center;
gap:10px;
margin-bottom:10px;
}

.profile img{
width:40px;
height:40px;
border-radius:50%;
object-fit:cover;
}

.flipped{
transform:rotateY(-180deg);
}

/* Chat */
.chatBox{
width:95%;
max-width:450px;
background:white;
margin-top:30px;
padding:15px;
border-radius:15px;
box-shadow:0 5px 15px rgba(0,0,0,0.2);
}

.message{
background:#dcf8c6;
padding:8px;
margin:5px 0;
border-radius:8px;
}

</style>
</head>
<body>

<div class="controls">
<h3>Create Diary</h3>
<input type="text" id="username" placeholder="Your Name">
<input type="file" id="profilePic" accept="image/*">
<input type="file" id="coverPhoto" accept="image/*">
<textarea id="diaryText" placeholder="Write diary..." rows="4"></textarea>
<button onclick="publish()">Publish Diary</button>
</div>

<div class="book" id="book"></div>

<div class="chatBox">
<h3>Friendsion Chat</h3>
<input type="text" id="chatName" placeholder="Your Name">
<input type="text" id="chatMsg" placeholder="Type message">
<button onclick="sendMsg()">Send</button>
<div id="messages"></div>
</div>

<script>

// Firebase config
const firebaseConfig = {
apiKey: "YOUR_API_KEY",
authDomain: "YOUR_AUTH",
databaseURL: "YOUR_DB",
projectId: "YOUR_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let coverBase64="", profileBase64="", editId=null;

// Image convert
function convert(file,callback){
const reader=new FileReader();
reader.onload=()=>callback(reader.result);
reader.readAsDataURL(file);
}

document.getElementById("coverPhoto").onchange=e=>{
convert(e.target.files[0],res=>coverBase64=res);
};

document.getElementById("profilePic").onchange=e=>{
convert(e.target.files[0],res=>profileBase64=res);
};

function publish(){
let name=document.getElementById("username").value;
let text=document.getElementById("diaryText").value;
if(!name||!text||!coverBase64||!profileBase64){
alert("Fill all fields!");
return;
}

let pages=text.match(/.{1,300}/g);

let data={
name:name,
profile:profileBase64,
cover:coverBase64,
pages:pages,
time:Date.now()
};

if(editId){
db.ref("diary/"+editId).set(data);
editId=null;
}else{
db.ref("diary").push(data);
}
alert("Saved!");
}

db.ref("diary").limitToLast(1).on("value",snap=>{
document.getElementById("book").innerHTML="";
snap.forEach(child=>{
let d=child.val();
let id=child.key;

let cover=document.createElement("div");
cover.className="page cover";
cover.innerHTML=`
<div class="profile">
<img src="${d.profile}">
<span>${d.name}</span>
</div>
<img src="${d.cover}">
<h2>Friendsion 11 Diary</h2>
<button onclick="editDiary('${id}')">Edit</button>
<button onclick="deleteDiary('${id}')">Delete</button>
`;
cover.onclick=function(){this.classList.toggle("flipped")};
document.getElementById("book").appendChild(cover);

d.pages.forEach((p,i)=>{
let page=document.createElement("div");
page.className="page";
page.style.zIndex=100-i;
page.innerHTML=p;
page.onclick=function(){this.classList.toggle("flipped")};
document.getElementById("book").appendChild(page);
});

});
});

function deleteDiary(id){
if(confirm("Delete diary?")){
db.ref("diary/"+id).remove();
}
}

function editDiary(id){
editId=id;
alert("Now edit and press Publish again");
}

// Chat
function sendMsg(){
let name=document.getElementById("chatName").value;
let msg=document.getElementById("chatMsg").value;
if(!name||!msg)return;

db.ref("chat").push({name,msg});
document.getElementById("chatMsg").value="";
}

db.ref("chat").limitToLast(20).on("value",snap=>{
let box=document.getElementById("messages");
box.innerHTML="";
snap.forEach(c=>{
let d=c.val();
box.innerHTML+=`<div class="message"><b>${d.name}:</b> ${d.msg}</div>`;
});
});

</script>
</body>
</html>
