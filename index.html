<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MassFrendz - Pro Max</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --fb-purple: #a033ff; --fb-bg: #f3f0f7; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--fb-bg); user-select: none; }
        nav { height: 56px; background: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .logo { color: var(--fb-purple); font-size: 24px; font-weight: bold; }
        .nav-right { display: flex; align-items: center; gap: 12px; }
        #myPicNav { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid var(--fb-purple); object-fit: cover; }
        #myNameDisplay { font-weight: 600; color: #333; font-size: 14px; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 10px; }
        .card { background: #fff; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .search-box { width: 100%; padding: 8px; border-radius: 20px; border: 1px solid #ddd; background: #f0f2f5; outline: none; margin-bottom: 10px; box-sizing: border-box; }
        
        .friend-list { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; }
        .friend { text-align: center; min-width: 70px; cursor: pointer; position: relative; }
        .friend img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--fb-purple); object-fit: cover; }
        .online-dot { position: absolute; bottom: 15px; right: 10px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; }
        
        .chat-container { position: fixed; bottom: 0; right: 20px; display: flex; align-items: flex-end; gap: 10px; pointer-events: none; }
        .chat-window { width: 320px; height: 450px; background: #fff; border-radius: 8px 8px 0 0; display: flex; flex-direction: column; box-shadow: 0 12px 28px rgba(0,0,0,0.2); pointer-events: auto; }
        .chat-header { background: #fff; padding: 10px; border-bottom: 1px solid #ddd; border-top: 3px solid var(--fb-purple); display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; background: #fff; position: relative; }
        
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 18px; font-size: 14px; word-wrap: break-word; cursor: pointer; transition: 0.2s; position: relative; margin-bottom: 2px; }
        .msg.me { align-self: flex-end; background: var(--fb-purple); color: #fff; }
        .msg.them { align-self: flex-start; background: #efeff3; color: #050505; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .msg.selected { opacity: 0.5; transform: scale(0.95); border: 2px solid var(--fb-purple); }
        .seen-status { font-size: 10px; color: var(--fb-purple); align-self: flex-end; margin-right: 5px; margin-bottom: 5px; }

        .selection-bar { display: none; background: var(--fb-purple); color: white; padding: 10px; justify-content: space-between; align-items: center; font-size: 14px; }
        .selection-bar button { background: white; color: var(--fb-purple); border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }

        .chat-input { padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 5px; align-items: center; }
        .chat-input input { flex: 1; border: none; background: #f0f2f5; padding: 8px 12px; border-radius: 20px; outline: none; }
        
        .menu-dots { cursor: pointer; padding: 5px; font-size: 18px; }
        .dropdown { position: absolute; right: 10px; top: 45px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 5px; display: none; z-index: 10; }
        .dropdown div { padding: 10px 15px; font-size: 13px; cursor: pointer; border-bottom: 1px solid #eee; }
        .dropdown div:hover { background: #f5f5f5; }
        .blocked-info { color: red; font-size: 12px; text-align: center; padding: 5px; width: 100%; }
        
        #fileInput, .chatMediaInput { display: none; }
    </style>
</head>
<body>

    <div id="login" style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="color:var(--fb-purple); font-size:50px;">MassFrendz</h1>
        <button onclick="login()" style="background:var(--fb-purple); color:white; border:none; padding:15px 30px; border-radius:6px; font-weight:bold; cursor:pointer;">Login with Gmail</button>
    </div>

    <div id="app" style="display:none">
        <nav>
            <div class="logo">MassFrendz</div>
            <div class="nav-right">
                <span id="myNameDisplay">Loading...</span>
                <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                <img id="myPicNav" title="Click to change Profile" onclick="triggerUpload()">
                <button onclick="updateName()" style="background:none; border:none; color:var(--fb-purple); font-weight:bold; cursor:pointer;">Edit Name</button>
                <button onclick="logout()" style="color:red; background:none; border:none; cursor:pointer;">Logout</button>
            </div>
        </nav>
        <div class="container">
            <div class="card">
                <input type="text" class="search-box" id="searchFriend" placeholder="Search friends..." oninput="loadFriends()">
                <div id="friends" class="friend-list"></div>
            </div>
        </div>
    </div>

    <div class="chat-container" id="chatArea"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAuGZse8FQyqM8XWeGFnvKTVSHy9etU0TA",
            authDomain: "massfrendz.firebaseapp.com",
            databaseURL: "https://massfrendz-default-rtdb.firebaseio.com/",
            projectId: "massfrendz"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let me = null;
        let selectedMsgs = {}; 
        let typingTimers = {};

        auth.onAuthStateChanged(user => {
            if (user) {
                me = user;
                document.getElementById('login').style.display = "none";
                document.getElementById('app').style.display = "block";
                
                db.ref("users/" + user.uid).on("value", s => {
                    let data = s.val() || {};
                    document.getElementById('myNameDisplay').innerText = data.name || user.displayName;
                    document.getElementById('myPicNav').src = data.pic || user.photoURL;
                    if(!s.exists()) db.ref("users/" + user.uid).set({ name: user.displayName, pic: user.photoURL, online: true });
                });

                db.ref("users/" + user.uid).update({ online: true });
                db.ref("users/" + user.uid).onDisconnect().update({ online: false });
                loadFriends();
            } else {
                document.getElementById('login').style.display = "flex";
                document.getElementById('app').style.display = "none";
            }
        });

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { if(me) db.ref("users/"+me.uid).update({online:false}); auth.signOut(); }
        function triggerUpload() { document.getElementById('fileInput').click(); }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => db.ref("users/" + me.uid).update({ pic: e.target.result });
                reader.readAsDataURL(file);
            }
        }

        function updateName() {
            let newName = prompt("Enter your new name:");
            if (newName && newName.trim() !== "") db.ref("users/" + me.uid).update({ name: newName.trim() });
        }

        function loadFriends() {
            let filter = document.getElementById('searchFriend').value.toLowerCase();
            db.ref("users").on("value", snap => {
                const fDiv = document.getElementById('friends'); fDiv.innerHTML = "";
                snap.forEach(child => {
                    if (child.key === me.uid) return;
                    let u = child.val();
                    if(u.name && u.name.toLowerCase().includes(filter)) {
                        fDiv.innerHTML += `<div class="friend" onclick="openChat('${child.key}','${u.name}')">
                            <img src="${u.pic || 'https://via.placeholder.com/50'}"><div class="online-dot" style="background:${u.online ? '#42b72a' : '#ccc'}"></div>
                            <br><small>${u.name.split(' ')[0]}</small></div>`;
                    }
                });
            });
        }

        async function openChat(uid, name) {
            let cid = me.uid < uid ? me.uid + "_" + uid : uid + "_" + me.uid;
            if (document.getElementById(cid)) return;
            selectedMsgs[cid] = [];

            let myBlock = (await db.ref(`blocks/${me.uid}/${uid}`).once('value')).val();
            let theirBlock = (await db.ref(`blocks/${uid}/${me.uid}`).once('value')).val();

            let chatHtml = `
                <div class="chat-window" id="${cid}">
                    <div class="selection-bar" id="bar_${cid}">
                        <span id="count_${cid}">0 Selected</span>
                        <div>
                            <button onclick="deleteSelected('${cid}', 'me')">For Me</button>
                            <button onclick="deleteSelected('${cid}', 'everyone')">Everyone</button>
                            <button onclick="cancelSelection('${cid}')" style="background:none;color:white;">X</button>
                        </div>
                    </div>
                    <div class="chat-header" id="head_${cid}">
                        <div><b>${name}</b><br><small id="type_${cid}" style="color:var(--fb-purple);display:none">typing...</small></div>
                        <div style="display:flex; align-items:center;">
                            <div class="menu-dots" onclick="toggleDrop('${cid}')">⋮</div>
                            <span style="cursor:pointer; margin-left:10px;" onclick="closeChat('${cid}')">✖</span>
                        </div>
                        <div class="dropdown" id="drop_${cid}">
                            <div onclick="toggleBlock('${uid}','${cid}')" style="color:red">${myBlock ? 'Unblock User' : 'Block User'}</div>
                            <div onclick="clearChat('${cid}', 'me')">Clear All (For Me)</div>
                            <div onclick="clearChat('${cid}', 'everyone')">Clear All (For Everyone)</div>
                        </div>
                    </div>
                    <div class="chat-body" id="body_${cid}"></div>
                    <div class="chat-input" id="input_${cid}">
                        ${(myBlock || theirBlock) ? '<div class="blocked-info">Chat is blocked</div>' : 
                        `<button onclick="document.getElementById('media_${cid}').click()" style="background:none;border:none;font-size:20px;cursor:pointer;color:gray;">+</button>
                        <input type="file" id="media_${cid}" class="chatMediaInput" accept="image/*" onchange="sendMedia('${cid}', this)">
                        <input type="text" id="inp_${cid}" placeholder="Aa" oninput="handleTyping('${cid}')" onkeypress="if(event.key==='Enter') sendMsg('${cid}')">
                        <button onclick="sendMsg('${cid}')" style="color:var(--fb-purple); background:none; border:none; font-weight:bold; cursor:pointer;">Send</button>`}
                    </div>
                </div>`;
            document.getElementById('chatArea').insertAdjacentHTML('beforeend', chatHtml);

            // NO DUPLICATE: Using Child Added and Child Changed for messages
            const msgRef = db.ref(`msgs/${cid}`);
            msgRef.on("child_added", s => renderMsg(cid, s));
            msgRef.on("child_changed", s => {
                const el = document.getElementById(`m_${cid}_${s.key}`);
                if(el) { document.getElementById(`body_${cid}`).innerHTML = ""; msgRef.once('value', snap => snap.forEach(child => renderMsg(cid, child))); }
            });

            // Typing listener for THIS specific chat
            db.ref(`typing/${cid}/${uid}`).on("value", s => {
                let tLabel = document.getElementById(`type_${cid}`);
                if(tLabel) tLabel.style.display = s.val() ? "block" : "none";
            });
        }

        function renderMsg(cid, s) {
            let m = s.val();
            let msgDiv = document.getElementById("body_" + cid);
            if(!msgDiv || m.deletedForMe === me.uid || m.everyone === true) return;

            // Mark as seen if it's from the other person
            if (m.s !== me.uid && !m.seen) db.ref(`msgs/${cid}/${s.key}/seen`).set(true);

            let div = document.createElement("div");
            div.className = `msg ${m.s === me.uid ? 'me' : 'them'}`;
            div.innerHTML = m.type === 'img' ? `<img src="${m.t}">` : m.t;
            div.id = `m_${cid}_${s.key}`;
            div.oncontextmenu = (e) => { e.preventDefault(); startSelection(cid, s.key); };
            div.onclick = () => { if(selectedMsgs[cid].length > 0) toggleSelect(cid, s.key); };
            msgDiv.appendChild(div);

            if(m.s === me.uid && m.seen) {
                let seenTag = document.createElement("div");
                seenTag.className = "seen-status"; seenTag.innerText = "Seen";
                seenTag.id = `seen_${s.key}`;
                msgDiv.appendChild(seenTag);
            }
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }

        function handleTyping(cid) {
            db.ref(`typing/${cid}/${me.uid}`).set(true);
            if(typingTimers[cid]) clearTimeout(typingTimers[cid]);
            typingTimers[cid] = setTimeout(() => {
                db.ref(`typing/${cid}/${me.uid}`).set(false);
            }, 1500);
        }

        function sendMsg(cid) {
            let inp = document.getElementById("inp_" + cid);
            if (!inp.value.trim()) return;
            db.ref("msgs/" + cid).push({ s: me.uid, t: inp.value, type: 'text', seen: false, everyone: false });
            inp.value = "";
            db.ref(`typing/${cid}/${me.uid}`).set(false);
        }

        function sendMedia(cid, el) {
            const file = el.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    db.ref("msgs/" + cid).push({ s: me.uid, t: e.target.result, type: 'img', seen: false, everyone: false });
                };
                reader.readAsDataURL(file);
            }
        }

        function closeChat(cid) {
            db.ref(`typing/${cid}/${me.uid}`).set(false);
            db.ref(`msgs/${cid}`).off();
            db.ref(`typing/${cid}`).off();
            document.getElementById(cid).remove();
        }

        function toggleBlock(uid, cid) {
            let ref = db.ref(`blocks/${me.uid}/${uid}`);
            ref.once('value', s => {
                if(s.exists()) ref.remove(); else ref.set(true);
                document.getElementById(cid).remove();
            });
        }
        function toggleDrop(cid) {
            let d = document.getElementById(`drop_${cid}`);
            d.style.display = d.style.display === "block" ? "none" : "block";
        }
        function startSelection(cid, mid) {
            if(!selectedMsgs[cid].includes(mid)) toggleSelect(cid, mid);
            document.getElementById(`bar_${cid}`).style.display = "flex";
            document.getElementById(`head_${cid}`).style.display = "none";
        }
        function toggleSelect(cid, mid) {
            let idx = selectedMsgs[cid].indexOf(mid);
            let el = document.getElementById(`m_${cid}_${mid}`);
            if(idx > -1) { selectedMsgs[cid].splice(idx, 1); el.classList.remove("selected"); } 
            else { selectedMsgs[cid].push(mid); el.classList.add("selected"); }
            document.getElementById(`count_${cid}`).innerText = selectedMsgs[cid].length + " Selected";
            if(selectedMsgs[cid].length === 0) cancelSelection(cid);
        }
        function cancelSelection(cid) {
            selectedMsgs[cid].forEach(mid => {
                let el = document.getElementById(`m_${cid}_${mid}`);
                if(el) el.classList.remove("selected");
            });
            selectedMsgs[cid] = [];
            document.getElementById(`bar_${cid}`).style.display = "none";
            document.getElementById(`head_${cid}`).style.display = "flex";
        }
        function deleteSelected(cid, type) {
            if(!confirm(`Delete selected for ${type}?`)) return;
            selectedMsgs[cid].forEach(mid => {
                if(type === 'me') db.ref(`msgs/${cid}/${mid}/deletedForMe`).set(me.uid);
                else db.ref(`msgs/${cid}/${mid}`).update({ everyone: true });
            });
            cancelSelection(cid);
        }
        function clearChat(cid, type) {
            if(!confirm(`Clear chat for ${type}?`)) return;
            db.ref("msgs/" + cid).once("value", snap => {
                snap.forEach(s => {
                    if(type === 'me') db.ref(`msgs/${cid}/${s.key}/deletedForMe`).set(me.uid);
                    else db.ref(`msgs/${cid}/${s.key}`).update({ everyone: true });
                });
            });
            toggleDrop(cid);
        }
    </script>
</body>
</html>

