<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendsion 11 - Ultimate Pro</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root { --fb-purple: #a033ff; --wa-green: #25d366; --wa-teal: #075e54; }
        body { background: #f0e6d2; display: flex; flex-direction: column; align-items: center; font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; }

        /* --- Persistent Login & Navbar --- */
        nav { width: 100%; height: 60px; background: white; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; box-sizing: border-box; }
        .logo { color: var(--fb-purple); font-size: 22px; font-weight: bold; }
        .user-nav img { width: 35px; border-radius: 50%; cursor: pointer; border: 2px solid var(--fb-purple); }

        /* --- Diary Flip (Mirror Fix) --- */
        .book-container { perspective: 1500px; margin: 20px 0; }
        .book { position: relative; width: 320px; height: 450px; transform-style: preserve-3d; transition: transform 0.6s; }
        .page { 
            position: absolute; width: 100%; height: 100%; top: 0; left: 0; 
            background: #fffef0; border: 1px solid #d4af37; border-radius: 0 15px 15px 0; 
            transform-origin: left; transition: transform 0.8s; 
            backface-visibility: hidden; z-index: 1; overflow: hidden;
        }
        .cover { background: linear-gradient(45deg, #ff00cc, #3333ff) !important; color: white; z-index: 10 !important; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .flipped { transform: rotateY(-180deg); }
        .nav-controls { position: absolute; bottom: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 15px; box-sizing: border-box; transform: rotateY(0); } /* Mirror fix */
        .nav-btn { background: #d4af37; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* --- WhatsApp Multi-Media Chat --- */
        .chat-window { position: fixed; bottom: 85px; right: 20px; width: 320px; height: 450px; background: #e5ddd5; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 2000; }
        .chat-header { background: var(--wa-teal); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        #chatMsgs { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px; border-radius: 8px; max-width: 80%; font-size: 14px; position: relative; word-wrap: break-word; }
        .msg img { width: 100%; border-radius: 5px; margin-bottom: 5px; }
        .msg.sent { background: #dcf8c6; align-self: flex-end; }
        .msg.received { background: white; align-self: flex-start; }
        
        .chat-input-bar { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 8px; }
        .chat-input-bar input { flex: 1; border: none; padding: 8px 15px; border-radius: 20px; outline: none; }
        .attachment-label { cursor: pointer; font-size: 20px; color: #666; }

        /* --- Video Call UI --- */
        #videoOverlay { position: fixed; inset: 0; background: black; z-index: 5000; display: none; flex-direction: column; color: white; }
        .video-box { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .remote-vid { width: 100%; height: 100%; object-fit: cover; }
        .local-vid { width: 100px; height: 150px; position: absolute; bottom: 20px; right: 20px; border: 2px solid white; background: #333; }
        .video-btns { height: 80px; display: flex; justify-content: center; align-items: center; gap: 30px; }
        .end-call { background: #ff4444; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        #loginArea { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .chat-btn-float { position: fixed; bottom: 20px; right: 20px; background: var(--wa-green); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 2000; }
    </style>
</head>
<body>

    <div id="loginArea">
        <h1 style="color:var(--fb-purple)">Friendsion 11</h1>
        <button onclick="login()" style="padding:15px 40px; border-radius:30px; border:none; background:var(--fb-purple); color:white; font-weight:bold; cursor:pointer;">Unlock Golden Diary</button>
    </div>

    <nav>
        <div class="logo">friendsion</div>
        <div class="user-nav" id="userNav"></div>
    </nav>

    <div id="mainApp" style="width:100%; display:none; flex-direction:column; align-items:center; padding-bottom:100px;">
        <div style="background:white; padding:15px; border-radius:12px; width:90%; max-width:400px; margin:20px 0; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
            <label style="display:block; background:#eee; padding:10px; border-radius:8px; text-align:center; cursor:pointer; margin-bottom:10px;">
                üì∏ Add Diary Cover <input type="file" id="coverInp" accept="image/*" style="display:none;">
            </label>
            <textarea id="diaryText" placeholder="Write your secret..." rows="3" style="width:100%; border:1px solid #ddd; border-radius:8px; padding:8px; box-sizing:border-box;"></textarea>
            <button onclick="savePost()" style="width:100%; margin-top:10px; background:#d4af37; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer;">Publish Diary</button>
        </div>
        <div id="feed"></div>
    </div>

    <div id="videoOverlay">
        <div class="video-box">
            <div id="remoteStatus">Calling...</div>
            <video id="localVideo" class="local-vid" autoplay muted></video>
        </div>
        <div class="video-btns">
            <div class="end-call" onclick="endCall()">‚ùå</div>
        </div>
    </div>

    <div class="chat-btn-float" onclick="toggleChat()">üí¨</div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <b>Global Chat</b>
            <div style="display:flex; gap:15px;">
                <span onclick="startCall()" style="cursor:pointer">üìπ</span>
                <span onclick="toggleChat()" style="cursor:pointer">‚úï</span>
            </div>
        </div>
        <div id="chatMsgs"></div>
        <div class="chat-input-bar">
            <label class="attachment-label">üñºÔ∏è<input type="file" id="chatFile" accept="image/*" style="display:none;" onchange="sendMedia(this)"></label>
            <input type="text" id="chatInp" placeholder="Type a message...">
            <button onclick="sendMsg()" style="background:none; border:none; color:var(--wa-teal); font-weight:bold; font-size:20px;">‚û§</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAUjZZ5RKf_-vu7gUDI3Frr4B2MbqC3Yg",
            authDomain: "friendsion-11-9e786.firebaseapp.com",
            databaseURL: "https://friendsion-11-9e786-default-rtdb.firebaseio.com",
            projectId: "friendsion-11-9e786"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let userData = null;

        // --- Persistent Login Logic ---
        auth.onAuthStateChanged(user => {
            if(user) {
                userData = user;
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('userNav').innerHTML = `<img src="${user.photoURL}" onclick="auth.signOut()">`;
                loadPosts();
                loadChat();
            } else {
                document.getElementById('loginArea').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        function login() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        }

        // --- Diary & Post Fix ---
        function savePost() {
            const t = document.getElementById('diaryText').value;
            const f = document.getElementById('coverInp').files[0];
            if(!t || !f) return alert("Photo & Text required!");
            const reader = new FileReader();
            reader.onload = (e) => {
                db.ref("diary_posts").push({
                    uid: userData.uid, uName: userData.displayName, uPic: userData.photoURL,
                    cover: e.target.result, pages: t.match(/.{1,250}/g), time: Date.now()
                });
                document.getElementById('diaryText').value = "";
            };
            reader.readAsDataURL(f);
        }

        function loadPosts() {
            db.ref("diary_posts").on("value", snap => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    let h = `<div class="book-container"><div class="book">
                        <div class="page cover" onclick="this.classList.add('flipped')">
                            <img src="${d.cover}" style="width:80%; height:180px; object-fit:cover; border-radius:8px;">
                            <h3>${d.uName}'s Diary</h3>
                        </div>`;
                    d.pages.forEach((p, i) => {
                        h += `<div class="page" style="z-index:${d.pages.length - i}">
                            <div style="padding:25px; line-height:1.6;">${p}</div>
                            <div class="nav-controls">
                                <button class="nav-btn" onclick="this.closest('.page').classList.remove('flipped')">Back</button>
                                <button class="nav-btn" onclick="${i === d.pages.length-1 ? 'this.closest(\'.book\').querySelectorAll(\'.page\').forEach(pg=>pg.classList.remove(\'flipped\'))' : 'this.closest(\'.page\').classList.add(\'flipped\')'}">
                                    ${i === d.pages.length-1 ? 'Reset' : 'Next'}
                                </button>
                            </div>
                        </div>`;
                    });
                    h += `</div></div>`;
                    feed.insertAdjacentHTML('afterbegin', h);
                });
            });
        }

        // --- Multimedia Chat & Video ---
        function toggleChat() { 
            const w = document.getElementById('chatWindow');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }

        function sendMsg() {
            const i = document.getElementById('chatInp');
            if(!i.value) return;
            db.ref("global_chat").push({ uid: userData.uid, name: userData.displayName, text: i.value, time: Date.now() });
            i.value = "";
        }

        function sendMedia(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                db.ref("global_chat").push({ uid: userData.uid, name: userData.displayName, img: e.target.result, time: Date.now() });
            };
            reader.readAsDataURL(file);
        }

        function loadChat() {
            db.ref("global_chat").on("value", snap => {
                const box = document.getElementById('chatMsgs');
                box.innerHTML = "";
                snap.forEach(c => {
                    const m = c.val();
                    const isMe = m.uid === userData.uid;
                    let content = m.img ? `<img src="${m.img}">` : m.text;
                    box.innerHTML += `<div class="msg ${isMe ? 'sent' : 'received'}" ondblclick="if(confirm('Delete?')) firebase.database().ref('global_chat/${c.key}').remove()">
                        <div style="font-size:9px; color:gray;">${m.name}</div>
                        ${content}
                    </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // --- Video Call System ---
        async function startCall() {
            document.getElementById('videoOverlay').style.display = 'flex';
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = stream;
        }
        function endCall() {
            const v = document.getElementById('localVideo');
            if(v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('videoOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
