<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Friendsion 11 - Pro Diary & Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#f0e6d2;font-family:sans-serif;margin:0;text-align:center}
.user-info{margin:20px}
.post-box{background:white;padding:20px;border-radius:15px;width:90%;max-width:400px;margin:auto}
textarea{width:100%;padding:10px;margin:10px 0}
.chat-btn{position:fixed;bottom:20px;right:20px;background:#25d366;
color:white;width:60px;height:60px;border-radius:50%;display:flex;
align-items:center;justify-content:center;font-size:28px;cursor:pointer}
.chat-window{position:fixed;bottom:90px;right:20px;width:320px;height:450px;
background:#e5ddd5;border-radius:10px;display:none;flex-direction:column}
.chat-header{background:#075e54;color:white;padding:10px}
#chatMsgs{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column}
.msg{padding:8px;border-radius:10px;margin:4px 0;max-width:75%}
.sent{background:#dcf8c6;align-self:flex-end}
.received{background:white;align-self:flex-start}
</style>
</head>
<body>

<div id="loginArea">
<button onclick="login()">Login With Google</button>
</div>

<div id="mainApp" style="display:none">
<div class="user-info">
<img id="userPic" width="40" style="border-radius:50%">
<span id="userName"></span>
<button onclick="logout()">Logout</button>
</div>

<div class="post-box">
<textarea id="diaryText" placeholder="Write diary..."></textarea>
<button onclick="savePost()">Publish</button>
</div>

<div id="feed"></div>
</div>

<div class="chat-btn" onclick="toggleChat()">ðŸ’¬</div>

<div class="chat-window" id="chatWindow">
<div class="chat-header">Global Chat</div>
<div id="chatMsgs"></div>
<div style="display:flex">
<input id="chatInp" style="flex:1">
<button onclick="sendMsg()">Send</button>
</div>
</div>

<script>
const firebaseConfig = {
apiKey: "YOUR_KEY",
authDomain: "friendsion-11-9e786.firebaseapp.com",
databaseURL: "https://friendsion-11-9e786-default-rtdb.firebaseio.com",
projectId: "friendsion-11-9e786"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
let userData=null;

auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

auth.onAuthStateChanged(user=>{
if(user){
userData=user;
document.getElementById("loginArea").style.display="none";
document.getElementById("mainApp").style.display="block";
document.getElementById("userPic").src=user.photoURL;
document.getElementById("userName").innerText=user.displayName;
loadPosts();
loadChat();
}
});

function login(){
auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout(){
auth.signOut();
location.reload();
}

function savePost(){
const text=document.getElementById("diaryText").value;
if(!text)return alert("Write something!");
db.ref("diary_posts").push({
uid:userData.uid,
name:userData.displayName,
text:text,
time:Date.now()
});
document.getElementById("diaryText").value="";
}

function loadPosts(){
db.ref("diary_posts").on("value",snap=>{
const feed=document.getElementById("feed");
feed.innerHTML="";
snap.forEach(child=>{
const d=child.val();
feed.innerHTML+=`
<div style="background:white;margin:10px;padding:10px;border-radius:10px">
<b>${d.name}</b>
<p>${d.text}</p>
</div>`;
});
});
}

/* ================= CHAT SYSTEM ================= */

function toggleChat(){
const win=document.getElementById("chatWindow");
win.style.display=win.style.display==="flex"?"none":"flex";
}

function sendMsg(){
const inp=document.getElementById("chatInp");
if(!inp.value)return;

db.ref("global_chat").push({
uid:userData.uid,
name:userData.displayName,
text:inp.value,
time:Date.now(),
deletedFor:{}
});
inp.value="";
}

function loadChat(){
db.ref("global_chat").limitToLast(50).on("value",snap=>{
const box=document.getElementById("chatMsgs");
box.innerHTML="";
snap.forEach(c=>{
const key=c.key;
const m=c.val();

if(m.deletedFor && m.deletedFor[userData.uid]) return;

const isMe=m.uid===userData.uid;

box.innerHTML+=`
<div class="msg ${isMe?'sent':'received'}"
onclick="deleteOptions('${key}','${m.uid}')">
<b style="font-size:10px">${isMe?'You':m.name}</b><br>
${m.text==="deleted"?"<i>This message was deleted</i>":m.text}
</div>`;
});
box.scrollTop=box.scrollHeight;
});
}

function deleteOptions(id,owner){
if(owner===userData.uid){
let choice=prompt("1 = Delete for Me\n2 = Delete for Everyone");
if(choice==="1"){
db.ref("global_chat/"+id+"/deletedFor/"+userData.uid).set(true);
}
if(choice==="2"){
db.ref("global_chat/"+id+"/text").set("deleted");
}
}else{
db.ref("global_chat/"+id+"/deletedFor/"+userData.uid).set(true);
}
}

</script>
</body>
</html>
