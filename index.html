<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendsion 11 - Pro Diary</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --fb-purple: #a033ff; --fb-bg: #f3f0f7; --diary-gold: #d4af37; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--fb-bg); overflow-x: hidden; }
        
        /* Nav & Layout */
        nav { height: 60px; background: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { color: var(--fb-purple); font-size: 26px; font-weight: bold; }
        .nav-right img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--fb-purple); }

        /* Diary Create Post */
        .create-diary { background: #fff; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .diary-input { width: 100%; border: none; background: #f0f2f5; border-radius: 15px; padding: 15px; font-size: 16px; outline: none; box-sizing: border-box; }

        /* 3D Diary Post in Feed */
        .post-card { background: #fff; max-width: 500px; margin: 25px auto; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .book-shell { perspective: 1200px; width: 260px; height: 360px; margin: 20px auto; cursor: pointer; }
        .book { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s; }
        .page { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 0 12px 12px 0; border: 1px solid #ddd; transform-origin: left; transition: transform 0.8s; }
        
        /* Multicolor Covers */
        .cover { background: linear-gradient(45deg, #a033ff, #ff33a0); color: white; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .cover img { width: 80%; height: 180px; object-fit: cover; border: 3px solid white; border-radius: 8px; margin: 10px 0; }
        .inner-page { background: #fffdf5; padding: 25px; color: #333; line-height: 1.6; font-family: 'Georgia', serif; }

        .flipped { transform: rotateY(-180deg); }

        /* Chat Window (MassFrendz Logic) */
        .chat-container { position: fixed; bottom: 0; right: 20px; display: flex; align-items: flex-end; gap: 10px; pointer-events: none; z-index: 2000; }
        .chat-window { width: 300px; height: 400px; background: #fff; border-radius: 10px 10px 0 0; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); pointer-events: auto; }
        .chat-header { background: #fff; padding: 10px; border-bottom: 1px solid #eee; border-top: 4px solid var(--fb-purple); display: flex; justify-content: space-between; }
        .chat-body { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; display: flex; flex-direction: column; gap: 4px; }
        .msg { padding: 8px 12px; border-radius: 15px; font-size: 13px; max-width: 80%; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--fb-purple); color: white; }
        .msg.them { align-self: flex-start; background: #e4e6eb; color: black; }
        
        .selection-bar { display: none; background: var(--fb-purple); color: white; padding: 8px; justify-content: space-between; font-size: 12px; }

        /* Friend List */
        .friend-bar { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; }
        .f-item { text-align: center; min-width: 65px; cursor: pointer; }
        .f-item img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--fb-purple); }
    </style>
</head>
<body>

    <nav>
        <div class="logo">friendsion</div>
        <div class="nav-right" id="navUser" style="display:none;">
            <img id="myPic" src="">
        </div>
    </nav>

    <div id="login" style="height:80vh; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="color:var(--fb-purple)">Unlock Your Diary</h1>
        <button onclick="login()" style="background:var(--fb-purple); color:white; border:none; padding:12px 30px; border-radius:25px; cursor:pointer; font-weight:bold;">Login with Gmail</button>
    </div>

    <div id="app" style="display:none">
        <div class="create-diary">
            <input type="file" id="coverPhoto" accept="image/*" style="display:none">
            <button onclick="document.getElementById('coverPhoto').click()" style="margin-bottom:10px; background:#eee; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">üì∏ Gallery Cover</button>
            <textarea id="diaryText" class="diary-input" placeholder="What's your story today?"></textarea>
            <button onclick="saveDiary()" style="width:100%; margin-top:10px; background:var(--fb-purple); color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">Publish to Diary Feed</button>
        </div>

        <div class="create-diary" style="background:none; box-shadow:none;">
            <div id="friends" class="friend-bar"></div>
        </div>

        <div id="feed"></div>
    </div>

    <div class="chat-container" id="chatArea"></div>

    <script>
        // --- Firebase Config (Same as MassFrendz) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAuGZse8FQyqM8XWeGFnvKTVSHy9etU0TA",
            authDomain: "massfrendz.firebaseapp.com",
            databaseURL: "https://massfrendz-default-rtdb.firebaseio.com/",
            projectId: "massfrendz"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let me = null;
        let selectedCover = "";

        // Login Logic
        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        auth.onAuthStateChanged(user => {
            if(user) {
                me = user;
                document.getElementById('login').style.display='none';
                document.getElementById('app').style.display='block';
                document.getElementById('navUser').style.display='block';
                document.getElementById('myPic').src = user.photoURL;
                db.ref("users/"+user.uid).set({ name: user.displayName, pic: user.photoURL, online: true });
                loadFriends();
                loadFeed();
            }
        });

        // Cover Photo Gallery Logic
        document.getElementById('coverPhoto').onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => selectedCover = ev.target.result;
            reader.readAsDataURL(e.target.files[0]);
        };

        // Save Diary (Facebook style Post)
        function saveDiary() {
            const txt = document.getElementById('diaryText').value;
            if(!txt || !selectedCover) return alert("Select Cover Photo and write text!");
            const pages = txt.match(/.{1,300}/g);
            db.ref("diary_posts").push({
                uName: me.displayName, uPic: me.photoURL,
                cover: selectedCover, pages: pages, time: Date.now()
            });
            document.getElementById('diaryText').value = "";
            selectedCover = "";
        }

        // Load Feed with 3D Flip
        function loadFeed() {
            db.ref("diary_posts").orderByChild("time").on("value", snap => {
                const feed = document.getElementById('feed'); feed.innerHTML = "";
                snap.forEach(child => {
                    const d = child.val();
                    let html = `
                    <div class="post-card">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                            <img src="${d.uPic}" style="width:35px; border-radius:50%">
                            <b>${d.uName}</b>
                        </div>
                        <div class="book-shell" onclick="this.querySelector('.book').classList.toggle('flipped')">
                            <div class="book">
                                <div class="page cover">
                                    <h2 style="margin:0; font-size:18px;">Friendsion Diary</h2>
                                    <img src="${d.cover}">
                                    <small>Tap to Read Story</small>
                                </div>
                                <div class="page inner-page">
                                    ${d.pages[0]}
                                    <div style="position:absolute; bottom:10px; right:10px; font-size:10px;">Page 1</div>
                                </div>
                            </div>
                        </div>
                        <div style="border-top:1px solid #eee; padding-top:10px; display:flex; gap:20px; color:#65676b; font-size:14px;">
                            <span>üëç Like</span> <span>üí¨ Comment</span>
                        </div>
                    </div>`;
                    feed.innerHTML = html + feed.innerHTML;
                });
            });
        }

        // --- Chat Logic (MassFrendz Style) ---
        function loadFriends() {
            db.ref("users").on("value", snap => {
                const fDiv = document.getElementById('friends'); fDiv.innerHTML = "";
                snap.forEach(child => {
                    if(child.key === me.uid) return;
                    let u = child.val();
                    fDiv.innerHTML += `<div class="f-item" onclick="openChat('${child.key}','${u.name}')">
                        <img src="${u.pic}"> <br><small>${u.name.split(' ')[0]}</small>
                    </div>`;
                });
            });
        }

        function openChat(uid, name) {
            let cid = me.uid < uid ? me.uid+"_"+uid : uid+"_"+me.uid;
            if(document.getElementById(cid)) return;
            let chatHtml = `
                <div class="chat-window" id="${cid}">
                    <div class="chat-header">
                        <b>${name}</b>
                        <span style="cursor:pointer" onclick="document.getElementById('${cid}').remove()">‚úñ</span>
                    </div>
                    <div class="chat-body" id="body_${cid}"></div>
                    <div style="padding:10px; display:flex; gap:5px;">
                        <input type="text" id="inp_${cid}" style="flex:1; border-radius:15px; border:1px solid #ddd; padding:5px 10px;" placeholder="Aa">
                        <button onclick="sendMsg('${cid}')" style="border:none; color:var(--fb-purple); background:none; font-weight:bold;">Send</button>
                    </div>
                </div>`;
            document.getElementById('chatArea').insertAdjacentHTML('beforeend', chatHtml);
            db.ref(`msgs/${cid}`).on("child_added", s => {
                let m = s.val();
                let b = document.getElementById("body_"+cid);
                let div = document.createElement("div");
                div.className = `msg ${m.s === me.uid ? 'me' : 'them'}`;
                div.innerText = m.t;
                b.appendChild(div);
                b.scrollTop = b.scrollHeight;
            });
        }

        function sendMsg(cid) {
            let inp = document.getElementById("inp_"+cid);
            if(!inp.value) return;
            db.ref("msgs/"+cid).push({ s: me.uid, t: inp.value });
            inp.value = "";
        }
    </script>
</body>
</html>
